<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Apna Ghar — AI Access Demo</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 20px; }
    .lead { max-width: 560px; margin: 0 auto; }
    .field { margin-bottom: 12px; }
    .field label { display:block; margin-bottom:6px; }
    input[type="text"], input[type="email"], input[type="tel"], textarea {
      width:100%; padding:8px; box-sizing: border-box;
    }
    button { padding:10px 14px; cursor:pointer; }
    #lead-modal.active { display:block; }
    #lead-modal { display:none; position:fixed; left:0; right:0; top:0; bottom:0; background:rgba(0,0,0,0.5);
      display:flex; align-items:center; justify-content:center; }
    #lead-modal .card { background:#fff; padding:20px; border-radius:8px; width:90%; max-width:480px; }
    .log { background:#f5f5f5; padding:10px; font-family:monospace; height:120px; overflow:auto; }
  </style>
</head>
<body>
  <div class="lead">
    <h2>AI Access (Apna Ghar) — Demo</h2>
    <p>Enter details to unlock AI content. (This page uses EmailJS for lead emails.)</p>

    <div class="field">
      <label for="lead-name">Name</label>
      <input id="lead-name" type="text" placeholder="Full name" />
    </div>

    <div class="field">
      <label for="lead-email">Email</label>
      <input id="lead-email" type="email" placeholder="Email address" />
    </div>

    <div class="field">
      <label for="lead-phone">Phone (optional)</label>
      <input id="lead-phone" type="tel" placeholder="Phone number" />
    </div>

    <button id="unlock-btn">UNLOCK ACCESS</button>

    <h3>AI Output</h3>
    <div id="ai-output" style="white-space:pre-wrap; border:1px solid #ddd; padding:10px; min-height:120px;"></div>

    <h4>Debug log (console mirror)</h4>
    <div id="dbg" class="log"></div>
  </div>

  <!-- Modal for lead capture -->
  <div id="lead-modal">
    <div class="card">
      <h3>Confirm details</h3>
      <div class="field">
        <label for="confirm-name">Name</label>
        <input id="confirm-name" type="text" />
      </div>
      <div class="field">
        <label for="confirm-email">Email</label>
        <input id="confirm-email" type="email" />
      </div>
      <div style="text-align:right;">
        <button id="lead-send">SEND & UNLOCK</button>
        <button id="lead-cancel">CANCEL</button>
      </div>
    </div>
  </div>

  <!-- EmailJS SDK -->
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>

  <script>
    /****************************************************************
     * CONFIGURATION (edit these values as-needed)
     *
     * Recommended: Keep PROXY_MODE=true (call your server endpoint),
     * and have the server call the Google Generative API with the key.
     ****************************************************************/
    const SERVICE_ID = "service_d5404dw";         // from your screenshot
    const TEMPLATE_ID = "template_rg6sr9f";       // from your screenshot
    const EMAILJS_PUBLIC_KEY = "JzFLkksbZNqethvDF";// from your screenshot (public key)

    // If you want to test direct client-side Google calls (not secure for prod),
    // set PROXY_MODE = false and put your key in DIRECT_GOOGLE_API_KEY.
    // Otherwise set PROXY_MODE = true and create a small server endpoint /api/gemini
    // that calls Google with the secret key.
    const PROXY_MODE = true;
    const PROXY_ENDPOINT = "/api/gemini"; // change to your serverless function URL if deployed
    const DIRECT_GOOGLE_API_KEY = "YOUR_GOOGLE_API_KEY_HERE"; // placeholder only (unsafe in prod)

    // Initialize EmailJS (public key is OK on client)
    (function(){
      emailjs.init(EMAILJS_PUBLIC_KEY);
      logDbg("EmailJS initialized (public key set).");
    })();

    // UI elements
    const btn = document.getElementById('unlock-btn');
    const modal = document.getElementById('lead-modal');
    const confirmName = document.getElementById('confirm-name');
    const confirmEmail = document.getElementById('confirm-email');
    const leadSend = document.getElementById('lead-send');
    const leadCancel = document.getElementById('lead-cancel');
    const dbg = document.getElementById('dbg');
    const aiOutput = document.getElementById('ai-output');

    // Local state: is user allowed?
    let isAccessGranted = false;

    // Utility: append to debug area and console
    function logDbg(...args){
      console.log(...args);
      dbg.textContent += args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ') + '\n';
      dbg.scrollTop = dbg.scrollHeight;
    }

    // checkAccess now accepts the event (so no implicit global event)
    function checkAccess(evt) {
      if (!isAccessGranted) {
        if (evt && evt.stopImmediatePropagation) evt.stopImmediatePropagation();
        // open modal
        document.getElementById('confirm-name').value = document.getElementById('lead-name').value || '';
        document.getElementById('confirm-email').value = document.getElementById('lead-email').value || '';
        modal.classList.add('active');
        return false;
      }
      return true;
    }

    // Click unlock: open modal (or proceed if already granted)
    btn.addEventListener('click', (e) => {
      if (!checkAccess(e)) return;
      // already granted: call AI directly
      requestAIAndShow("Give me a short study plan for learning waves in physics (JEE level).");
    });

    // modal buttons
    leadCancel.addEventListener('click', () => {
      modal.classList.remove('active');
    });

    leadSend.addEventListener('click', () => {
      // read values from confirm inputs
      const name = confirmName.value.trim();
      const email = confirmEmail.value.trim();
      const phone = document.getElementById('lead-phone').value.trim();

      if (!name || !email) {
        alert("Please enter name and email.");
        return;
      }

      // Send via EmailJS and on success grant access
      const params = {
        name: name,
        email: email,
        phone: phone,
        source: "ApnaGhar - Website"
      };

      btn.disabled = true;
      btn.textContent = "SENDING...";

      logDbg("Sending EmailJS with params:", params);
      emailjs.send(SERVICE_ID, TEMPLATE_ID, params)
        .then(resp => {
          logDbg("EmailJS success:", resp);
          localStorage.setItem('apnaGharLead', JSON.stringify(params));
          isAccessGranted = true;
          modal.classList.remove('active');
          btn.disabled = false;
          btn.textContent = "UNLOCK ACCESS";
          alert("Access granted. You can now request AI output.");
          // optional: auto-call the AI after granting access:
          requestAIAndShow("Create a short JEE-level summary on simple harmonic motion with formulas and one practice problem.");
        })
        .catch(err => {
          console.error('EmailJS error:', err);
          logDbg("EmailJS error:", err);
          alert("Failed to send lead info. Check console/network and your EmailJS settings.");
          btn.disabled = false;
          btn.textContent = "UNLOCK ACCESS";
        });
    });

    /**************************************************************************
     * requestAIAndShow(prompt)
     *
     * This function will call either:
     *  - your serverless proxy (PROXY_MODE=true) at PROXY_ENDPOINT, or
     *  - Google Generative API directly (PROXY_MODE=false) using DIRECT_GOOGLE_API_KEY.
     *
     * IMPORTANT: For production ALWAYS use a server-side proxy to hide your API key.
     **************************************************************************/
    async function requestAIAndShow(prompt) {
      aiOutput.textContent = "Thinking...";
      logDbg("AI request prompt:", prompt);

      try {
        let resultText = "";

        if (PROXY_MODE) {
          // PROXY approach: front-end -> your serverless function -> Google API (server keeps the real key)
          logDbg("Calling proxy endpoint:", PROXY_ENDPOINT);
          const res = await fetch(PROXY_ENDPOINT, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ prompt })
          });
          logDbg("Proxy HTTP status:", res.status);
          const payload = await res.json().catch(() => null);
          if (res.ok && payload) {
            logDbg("Proxy JSON payload:", payload);
            resultText = payload.output || (payload?.candidates?.[0]?.content?.parts?.[0]?.text ?? JSON.stringify(payload));
          } else {
            logDbg("Proxy returned error:", res.status, payload);
            resultText = `Proxy error ${res.status}: ${JSON.stringify(payload)}`;
          }
        } else {
          // Direct Google call (unsafe on client). Only for quick tests.
          if (!DIRECT_GOOGLE_API_KEY || DIRECT_GOOGLE_API_KEY === "YOUR_GOOGLE_API_KEY_HERE") {
            throw new Error("DIRECT_GOOGLE_API_KEY not set. Set it or use PROXY_MODE=true.");
          }
          const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${DIRECT_GOOGLE_API_KEY}`;
          logDbg("Calling Google directly (unsafe) ->", url);
          const body = {
            // This object format follows the Generative Language API pattern. Adjust if API differs.
            temperature: 0.2,
            candidateCount: 1,
            prompt: {
              text: prompt
            }
          };
          const res = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
          });
          logDbg("Google HTTP status:", res.status);
          const text = await res.text();
          try {
            const j = JSON.parse(text);
            logDbg("Google JSON:", j);
            resultText = j?.candidates?.[0]?.content?.parts?.[0]?.text ?? JSON.stringify(j);
          } catch (e) {
            logDbg("Non-JSON Google response:", text);
            resultText = text;
          }
        }

        aiOutput.textContent = resultText;
        logDbg("AI result shown.");

      } catch (err) {
        console.error("AI request failed:", err);
        logDbg("AI request failed:", err);
        aiOutput.textContent = "AI request failed. Check console and network logs.";
      }
    }

    /****************************************************************
     * NOTES & QUICK TROUBLESHOOT (think like reading experiment residuals)
     *
     * - If EmailJS send fails: open DevTools → Network → filter by "emailjs".
     *   Look for status codes (401/403 = key/service mismatch; 400 = bad template params).
     *
     * - If proxy returns 401/403: the server's Google key is wrong or the Generative API is not
     *   enabled on that Google Cloud project (or billing/quotas).
     *
     * - If you get CORS errors calling PROXY_ENDPOINT, ensure your serverless function
     *   returns appropriate CORS headers (Access-Control-Allow-Origin).
     *
     * - Physics analogy: EmailJS params are like matching boundary conditions; the Google key
     *   is like a conserved charge — it must be kept inside a protected container (server).
     ****************************************************************/

    // OPTIONAL: auto-reload a cached lead (simple UX)
    (function tryRestoreLead() {
      try {
        const s = localStorage.getItem('apnaGharLead');
        if (s) {
          const lead = JSON.parse(s);
          document.getElementById('lead-name').value = lead.name || '';
          document.getElementById('lead-email').value = lead.email || '';
          document.getElementById('lead-phone').value = lead.phone || '';
          // You might choose to restore access automatically or require re-validation:
          // isAccessGranted = true;
        }
      } catch(e) { /* ignore */ }
    })();
  </script>
</body>
</html>
